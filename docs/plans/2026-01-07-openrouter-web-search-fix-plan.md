Author: Cascade (GPT-4.1 Code Interpreter)  
Date: 2026-01-07  
PURPOSE: Establish investigation + remediation tasks to stop unintended OpenRouter web-search plugin charges originating from SnakeBench/WormArena flows.  
SRP/DRY check: Pass — plan only documents scope/approach; no code changes.

# 2026-01-07 – OpenRouter Web Search Fix Plan

## 1. Background
- Audit file `docs/OPENROUTER_WEB_SEARCH_AUDIT.md` confirms every SnakeBench/WormArena OpenRouter call is billed an extra $0.02 because OpenRouter’s web search plugin is being auto-enabled.
- Root cause is unknown but likely due to overly permissive `extract_api_kwargs()` in `external/SnakeBench/backend/llm_providers.py` passing through arbitrary config/database fields (e.g., `plugins`) to OpenRouter payloads.
- No `:online` models exist, so plugin activation must come from request body content.
- Priority is **critical** because the phantom spend compounds with every live match.

## 2. Objectives
1. **Stop the bleeding immediately** — prevent any future OpenRouter request from sending `plugins` or other unintended instructions.
2. **Identify & clean the data source** — locate where `plugins` (or similar) enters player configs (database column, metadata JSON, manual overrides, etc.).
3. **Add regression safeguards** — logging/tests that fail loudly when web search is reintroduced.
4. **Document the fix** — update audit doc + CHANGELOG so operators understand the economics and remediation.

## 3. Non-Goals
- No changes to main ARC Explainer OpenRouter service (already clean).
- No holistic SnakeBench refactor beyond plugin leakage + instrumentation needed for this issue.
- No pricing reconciliation work; we only stop new charges and document steps to ask OpenRouter for credits separately.

## 4. Investigation Tasks
1. **Instrument OpenRouterProvider** (temporary logging guard):
   - Log `request_kwargs` prior to API call (redacting sensitive fields) behind an env flag.
   - Raise on detection of `plugins` so tests fail locally.
2. **Trace config sources**:
   - Inspect `model_repository` + DB schema (fields, metadata JSON contents) to see if `plugins` exists anywhere.
   - Review YAML/JSON config loaders or BYOK overrides for plugin mentions.
   - Check OpenRouter catalog sync payloads for `supported_parameters` or other arrays that might include `web`.
3. **Confirm reproduction**:
   - Run a dry-run provider call with a captured config that currently produces the $0.02 charge.
   - Capture the outgoing request body for documentation.

## 5. Implementation Tasks
1. **Sanitize API kwargs**:
   - Update `LLMProviderInterface.extract_api_kwargs()` to maintain an explicit allowlist (model-agnostic) instead of “allow everything except known_fields”.
   - Explicitly drop `plugins`, `transforms`, `tools`, or any `*_plugins` keys unless whitelisted.
   - Add inline comments referencing OpenRouter doc + cost impact.
2. **Final guard inside OpenRouterProvider.get_response()`**:
   - Before calling the SDK, assert `plugins` not present; if found, remove and log a structured warning/error.
3. **Data hygiene**:
   - If DB records contain `plugins`, migrate them out or add a cleansing step before configs reach providers.
   - Ensure sync script (`cli/sync_openrouter_models.py`) never persists plugin data (if OpenRouter API supplies it in metadata).
4. **Tests**:
   - Extend `backend/tests/test_llm_providers.py` with a failing fixture whenever `plugins` sneaks in.
   - Add regression fixture verifying `extract_api_kwargs()` only returns expected keys.
5. **Docs & CHANGELOG**:
   - Update `docs/OPENROUTER_WEB_SEARCH_AUDIT.md` with resolution steps + verification instructions.
   - Add CHANGELOG entry (SemVer patch) summarizing what/why/how.

## 6. Validation & Rollout
1. Unit tests: `backend/tests/test_llm_providers.py`.
2. Manual verification:
   - Run a local match (or provider smoke test) with logging enabled to confirm outgoing payload lacks `plugins`.
   - Inspect OpenRouter billing dashboard (if accessible) for absence of new $0.02 line items.
3. Production rollout:
   - Deploy sanitized SnakeBench backend.
   - Monitor logs for any guard-triggered warnings.

## 7. Open Questions / Risks
1. Do any legitimate workflows require `plugins` (e.g., future tool integrations)? If so, we need opt-in toggles rather than blanket stripping.
2. Are there other costly plugin IDs besides `"web"` that OpenRouter injects by default?
3. Does the database currently contain configs with nested metadata we can’t mutate safely without a migration?

## 8. Success Criteria
- No OpenRouter payload generated by SnakeBench/WormArena contains `plugins`.
- Billing statements show zero new $0.02 web-search charges post-deploy.
- Tests + logging cover regressions and clearly document why `plugins` is forbidden.
