# Flexible Puzzle Processor Guide

**Author:** Cascade using Claude 3.5 Sonnet  
**Date:** 2025-09-26  
**Purpose:** Complete guide for the new flexible puzzle processing engine that replaces the old hardcoded scripts

## Overview

The `flexible-puzzle-processor.ts` script is a comprehensive replacement for:
- `retry-failed-puzzles.ts` (poorly named, actually processed any puzzles)
- `analyze-unsolved-puzzles.ts` (hardcoded to evaluation directory)
- `puzzle-analysis.ts` (query-only functionality)

**Key Improvements:**
- ✅ **Zero hardcoded values** - everything configurable via command line
- ✅ **Multiple operation modes** - analyze, query, validate, retry
- ✅ **Validation result tracking** with detailed accuracy reporting
- ✅ **Automatic failure recording** with retry file generation
- ✅ **Flexible puzzle sources** - directories, specific IDs, database queries
- ✅ **Database integration** for status checking and result validation
- ✅ **Configurable concurrency** with rate limiting and batching

## Quick Start

```bash
# Analyze all puzzles in evaluation2 directory
npm run process -- --mode analyze --source directory --directory evaluation2

# Query database for puzzle status
npm run process -- --mode query --source unsolved

# Validate existing results for a specific model
npm run process -- --mode validate --source directory --directory training --model gpt-4o-2024-08-06

# Retry specific failed puzzles
npm run process -- --mode retry --source ids --ids "08573cc6,0becf7df,0d87d2a6"
```

## Operation Modes

### 1. Analyze Mode (`--mode analyze`)
Triggers AI analysis for puzzles and saves results to database.

**Features:**
- Sends puzzles to AI models for analysis
- Saves results directly to database via API
- Shows validation results in real-time
- Records failures for retry

**Example:**
```bash
npm run process -- \
  --mode analyze \
  --source directory \
  --directory evaluation2 \
  --model gpt-4o-2024-08-06 \
  --reasoning-effort high \
  --max-concurrent 5
```

### 2. Query Mode (`--mode query`)
Queries database for puzzle status and model performance.

**Features:**
- Shows which models solved which puzzles
- Displays attempt counts and success rates
- No AI calls - pure database query
- Fast overview of current status

**Example:**
```bash
npm run process -- \
  --mode query \
  --source ids \
  --ids "08573cc6,0becf7df,0d87d2a6"
```

### 3. Validate Mode (`--mode validate`)
Checks existing database results for accuracy without re-running analysis.

**Features:**
- Validates prediction correctness flags
- Shows multi-test accuracy results
- No API calls - just database validation
- Useful for auditing existing data

**Example:**
```bash
npm run process -- \
  --mode validate \
  --source directory \
  --directory training \
  --model gpt-4o-2024-08-06
```

### 4. Retry Mode (`--mode retry`)
Re-runs analysis for previously failed puzzles.

**Features:**
- Loads failures from JSON file
- Same as analyze mode but focused on failures
- Automatically sets retryMode flag
- Generates new failure file if needed

**Example:**
```bash
npm run process -- \
  --mode retry \
  --source file \
  --file failures-2025-09-26T21-36-50-123Z.json
```

## Puzzle Sources

### Directory Source (`--source directory`)
Load puzzles from JSON files in a directory.

```bash
npm run process -- \
  --source directory \
  --directory evaluation2    # Uses data/evaluation2
```

### Specific IDs (`--source ids`)
Process specific puzzle IDs.

```bash
npm run process -- \
  --source ids \
  --ids "08573cc6,0becf7df,0d87d2a6"
```

### Unsolved Puzzles (`--source unsolved`)
Load puzzles that haven't been solved by any model yet.

```bash
npm run process -- --source unsolved
```

### File Input (`--source file`)
Load puzzle IDs from a text file (one per line).

```bash
npm run process -- \
  --source file \
  --file my-puzzles.txt
```

### Failed Puzzles (`--source failed`)
Load from a failure JSON file (generated by previous runs).

```bash
npm run process -- \
  --source failed \
  --file failures-2025-09-26T21-36-50-123Z.json
```

## Model Configuration

All model parameters are configurable:

```bash
npm run process -- \
  --model gpt-4o-2024-08-06 \
  --provider openai \
  --temperature 0.2 \
  --reasoning-effort high \
  --timeout 30
```

**Available Options:**
- `--model`: AI model identifier
- `--provider`: AI provider (openai, anthropic, etc.)
- `--temperature`: Temperature setting (0.0-1.0)
- `--reasoning-effort`: low, medium, high
- `--timeout`: Timeout in minutes per puzzle

## Execution Control

### Concurrency Settings
```bash
npm run process -- \
  --max-concurrent 10 \     # Max 10 simultaneous requests
  --delay 2000              # 2 second delay between requests
```

### Sequential Processing
```bash
npm run process -- \
  --no-concurrent           # Process one at a time
```

## Output and Reporting

### Validation Display
By default, shows prediction accuracy:
- ✅/❌ Validation passed
- ✅/❌ Single prediction correct
- ✅/❌/N/A Multi-test correct

Disable with `--no-validation`

### Failure Recording
Automatically creates failure files for retry:
```json
{
  "timestamp": "2025-09-26T21:36:50.000Z",
  "config": { "mode": "analyze", "model": "gpt-4o-2024-08-06" },
  "failed": [
    { "puzzleId": "08573cc6", "error": "Timeout after 30 minutes" }
  ],
  "retryCommand": "npm run process -- --mode retry --source file --file failures-2025-09-26T21-36-50-123Z.json"
}
```

Disable with `--no-failures`

### Results Export
Save detailed results to JSON:
```bash
npm run process -- \
  --output results-2025-09-26.json
```

## Real-World Examples

### 1. Full Evaluation Run
```bash
# Analyze all evaluation2 puzzles with GPT-4
npm run process -- \
  --mode analyze \
  --source directory \
  --directory evaluation2 \
  --model gpt-4o-2024-08-06 \
  --reasoning-effort high \
  --max-concurrent 5 \
  --delay 3000 \
  --output evaluation2-gpt4-results.json
```

### 2. Quick Status Check
```bash
# Check which puzzles are still unsolved
npm run process -- \
  --mode query \
  --source unsolved \
  --quiet
```

### 3. Targeted Retry
```bash
# Retry specific puzzles that failed
npm run process -- \
  --mode retry \
  --source ids \
  --ids "08573cc6,0becf7df" \
  --model gpt-5-mini-2025-08-07 \
  --reasoning-effort high
```

### 4. Validation Audit
```bash
# Check accuracy of existing results
npm run process -- \
  --mode validate \
  --source directory \
  --directory training \
  --model gpt-4o-2024-08-06
```

## Migration from Old Scripts

### From `retry-failed-puzzles.ts`
**Old:** Hardcoded GPT-5 model, evaluation2 directory
```bash
npm run retry evaluation2
```

**New:** Fully configurable
```bash
npm run process -- \
  --mode analyze \
  --source directory \
  --directory evaluation2 \
  --model gpt-5-mini-2025-08-07 \
  --reasoning-effort high
```

### From `analyze-unsolved-puzzles.ts`
**Old:** Hardcoded evaluation directory, GPT-5 nano
```bash
npm run au
```

**New:** Configurable model and source
```bash
npm run process -- \
  --mode analyze \
  --source unsolved \
  --model gpt-4o-2024-08-06
```

### From `puzzle-analysis.ts`
**Old:** Query only, hardcoded puzzle list
```bash
npm run ap
```

**New:** Flexible querying
```bash
npm run process -- \
  --mode query \
  --source directory \
  --directory evaluation
```

## Tips and Best Practices

1. **Start Small:** Test with a few puzzles first using `--source ids`
2. **Monitor Resources:** Use `--max-concurrent` to avoid overwhelming the API
3. **Save Results:** Always use `--output` for important runs
4. **Check Validation:** Enable validation to see accuracy in real-time
5. **Use Retry:** Failure files make it easy to retry just what failed
6. **Go Slow:** Use `--delay` to be respectful to API rate limits

## Troubleshooting

### Common Issues

**"No puzzles found"**
- Check directory exists: `data/evaluation2`
- Verify IDs are correct
- Check file format (one ID per line)

**"Database connection failed"**
- Verify DATABASE_URL in .env
- Check network connectivity
- Ensure database is running

**"API timeout"**
- Increase `--timeout` for complex puzzles
- Reduce `--max-concurrent`
- Check API_BASE_URL

### Getting Help
```bash
npm run process -- --help
```

This shows complete usage information and all available options.
